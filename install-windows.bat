@echo off
setlocal EnableDelayedExpansion
chcp 65001 > nul
title PageForge - Installation Windows

:: Couleurs pour l'affichage
set "ESC="
set "GREEN=%ESC%[92m"
set "RED=%ESC%[91m"
set "YELLOW=%ESC%[93m"
set "BLUE=%ESC%[94m"
set "RESET=%ESC%[0m"

echo.
echo %BLUE%‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó%RESET%
echo %BLUE%‚ïë                    üöÄ PAGEFORGE INSTALLER                    ‚ïë%RESET%
echo %BLUE%‚ïë                  Installation Automatique Windows           ‚ïë%RESET%
echo %BLUE%‚ïë                        Version 1.0.0                        ‚ïë%RESET%
echo %BLUE%‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù%RESET%
echo.

:: Variables
set "INSTALL_DIR=%CD%\pageforge"
set "NODE_MIN_VERSION=18"
set "REQUIRED_SPACE=500"
set "LOG_FILE=%TEMP%\pageforge-install.log"

echo %YELLOW%[INFO]%RESET% D√©marrage de l'installation PageForge...
echo %YELLOW%[INFO]%RESET% Dossier d'installation : %INSTALL_DIR%
echo.

:: Fonction de log
call :log "=== PageForge Installation Windows ==="
call :log "D√©but d'installation : %DATE% %TIME%"

:: √âtape 1 : V√©rification des pr√©requis
echo %BLUE%[1/7]%RESET% V√©rification des pr√©requis syst√®me...
call :check_prerequisites
if errorlevel 1 goto :error

:: √âtape 2 : V√©rification Node.js
echo %BLUE%[2/7]%RESET% V√©rification de Node.js...
call :check_nodejs
if errorlevel 1 goto :error

:: √âtape 3 : Cr√©ation du dossier d'installation
echo %BLUE%[3/7]%RESET% Pr√©paration du dossier d'installation...
call :prepare_directory
if errorlevel 1 goto :error

:: √âtape 4 : T√©l√©chargement/copie des fichiers
echo %BLUE%[4/7]%RESET% Installation des fichiers PageForge...
call :install_files
if errorlevel 1 goto :error

:: √âtape 5 : Installation des d√©pendances
echo %BLUE%[5/7]%RESET% Installation des d√©pendances NPM...
call :install_dependencies
if errorlevel 1 goto :error

:: √âtape 6 : Configuration de l'environnement
echo %BLUE%[6/7]%RESET% Configuration de l'environnement...
call :configure_environment
if errorlevel 1 goto :error

:: √âtape 7 : Tests et finalisation
echo %BLUE%[7/7]%RESET% Tests et finalisation...
call :finalize_installation
if errorlevel 1 goto :error

:: Succ√®s
echo.
echo %GREEN%‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó%RESET%
echo %GREEN%‚ïë                  ‚úÖ INSTALLATION R√âUSSIE !                   ‚ïë%RESET%
echo %GREEN%‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù%RESET%
echo.
echo %GREEN%üéâ PageForge a √©t√© install√© avec succ√®s !%RESET%
echo.
echo %YELLOW%üìÅ Dossier d'installation :%RESET% %INSTALL_DIR%
echo %YELLOW%üåê URL d'acc√®s :%RESET% http://localhost:5000
echo.
echo %BLUE%üöÄ Pour d√©marrer PageForge :%RESET%
echo    cd "%INSTALL_DIR%"
echo    npm run dev
echo.
echo %YELLOW%üìñ Documentation compl√®te disponible dans :%RESET% %INSTALL_DIR%\docs\
echo.

:: Proposition de d√©marrage automatique
set /p "start_now=Voulez-vous d√©marrer PageForge maintenant ? (O/n): "
if /i "!start_now!"=="O" (
    echo %BLUE%[INFO]%RESET% D√©marrage de PageForge...
    cd "%INSTALL_DIR%"
    start "" cmd /k "npm run dev"
    echo %GREEN%‚úÖ PageForge d√©marr√© !%RESET% Ouvrez http://localhost:5000 dans votre navigateur
)

call :log "Installation termin√©e avec succ√®s"
pause
goto :eof

:: ============================================================================
:: FONCTIONS
:: ============================================================================

:check_prerequisites
    call :log "V√©rification des pr√©requis"
    
    :: V√©rification de l'espace disque
    for /f "tokens=3" %%a in ('dir /-c ^| find "bytes free"') do set "free_space=%%a"
    set "free_space=!free_space:,=!"
    set /a "free_mb=!free_space!/1048576"
    
    if !free_mb! LSS %REQUIRED_SPACE% (
        echo %RED%‚ùå Espace disque insuffisant !%RESET%
        echo    Requis : %REQUIRED_SPACE% MB
        echo    Disponible : !free_mb! MB
        call :log "ERREUR: Espace disque insuffisant"
        exit /b 1
    )
    
    echo %GREEN%   ‚úÖ Espace disque suffisant (!free_mb! MB disponibles)%RESET%
    
    :: V√©rification des permissions
    echo test > "%TEMP%\pageforge-test.tmp" 2>nul
    if not exist "%TEMP%\pageforge-test.tmp" (
        echo %RED%‚ùå Permissions insuffisantes !%RESET%
        call :log "ERREUR: Permissions insuffisantes"
        exit /b 1
    )
    del "%TEMP%\pageforge-test.tmp" 2>nul
    
    echo %GREEN%   ‚úÖ Permissions suffisantes%RESET%
    call :log "Pr√©requis valid√©s"
    exit /b 0

:check_nodejs
    call :log "V√©rification Node.js"
    
    :: V√©rifier si Node.js est install√©
    node --version > nul 2>&1
    if errorlevel 1 (
        echo %RED%‚ùå Node.js n'est pas install√© !%RESET%
        echo.
        echo %YELLOW%üì• Installation de Node.js requise :%RESET%
        echo    1. T√©l√©chargez Node.js depuis : https://nodejs.org
        echo    2. Installez Node.js version 18 ou sup√©rieure
        echo    3. Red√©marrez ce script apr√®s installation
        echo.
        call :log "ERREUR: Node.js non install√©"
        pause
        exit /b 1
    )
    
    :: V√©rifier la version
    for /f "tokens=1 delims=." %%a in ('node --version') do (
        set "node_major=%%a"
        set "node_major=!node_major:v=!"
    )
    
    if !node_major! LSS %NODE_MIN_VERSION% (
        echo %RED%‚ùå Version Node.js insuffisante !%RESET%
        echo    Version install√©e : !node_major!
        echo    Version requise : %NODE_MIN_VERSION%+
        call :log "ERREUR: Version Node.js insuffisante"
        exit /b 1
    )
    
    echo %GREEN%   ‚úÖ Node.js version !node_major! d√©tect√©%RESET%
    
    :: V√©rifier NPM
    npm --version > nul 2>&1
    if errorlevel 1 (
        echo %RED%‚ùå NPM non disponible !%RESET%
        call :log "ERREUR: NPM non disponible"
        exit /b 1
    )
    
    echo %GREEN%   ‚úÖ NPM disponible%RESET%
    call :log "Node.js et NPM valid√©s"
    exit /b 0

:prepare_directory
    call :log "Pr√©paration du dossier d'installation"
    
    :: Cr√©er le dossier d'installation
    if exist "%INSTALL_DIR%" (
        echo %YELLOW%‚ö†Ô∏è  Le dossier %INSTALL_DIR% existe d√©j√†%RESET%
        set /p "overwrite=Voulez-vous le remplacer ? (O/n): "
        if /i "!overwrite!"=="O" (
            echo %YELLOW%   üóëÔ∏è  Suppression du dossier existant...%RESET%
            rmdir /s /q "%INSTALL_DIR%" 2>nul
            call :log "Dossier existant supprim√©"
        ) else (
            echo %RED%‚ùå Installation annul√©e par l'utilisateur%RESET%
            call :log "Installation annul√©e"
            exit /b 1
        )
    )
    
    mkdir "%INSTALL_DIR%" 2>nul
    if not exist "%INSTALL_DIR%" (
        echo %RED%‚ùå Impossible de cr√©er le dossier d'installation !%RESET%
        call :log "ERREUR: Cr√©ation dossier impossible"
        exit /b 1
    )
    
    echo %GREEN%   ‚úÖ Dossier d'installation cr√©√©%RESET%
    call :log "Dossier d'installation pr√©par√©"
    exit /b 0

:install_files
    call :log "Installation des fichiers"
    
    :: Recherche du fichier ZIP
    set "zip_found="
    for %%f in (pageforge-*.zip pageforge.zip build.zip) do (
        if exist "%%f" (
            set "zip_found=%%f"
            goto :zip_found
        )
    )
    
    :zip_found
    if not defined zip_found (
        echo %YELLOW%‚ö†Ô∏è  Aucun fichier ZIP PageForge trouv√©%RESET%
        echo.
        echo %BLUE%üì¶ Options d'installation :%RESET%
        echo    1. Placez le fichier pageforge.zip dans ce dossier
        echo    2. Ou t√©l√©chargement automatique (si disponible)
        echo.
        
        set /p "download_option=T√©l√©charger automatiquement ? (O/n): "
        if /i "!download_option!"=="O" (
            call :download_pageforge
            if errorlevel 1 exit /b 1
        ) else (
            echo %RED%‚ùå Fichier PageForge requis !%RESET%
            call :log "ERREUR: Fichier ZIP non trouv√©"
            exit /b 1
        )
    ) else (
        echo %GREEN%   ‚úÖ Fichier trouv√© : !zip_found!%RESET%
        call :extract_zip "!zip_found!"
        if errorlevel 1 exit /b 1
    )
    
    call :log "Fichiers install√©s"
    exit /b 0

:extract_zip
    call :log "Extraction du fichier ZIP : %~1"
    
    :: Utiliser PowerShell pour extraire (Windows 10+)
    powershell -Command "Expand-Archive -Path '%~1' -DestinationPath '%INSTALL_DIR%' -Force" > nul 2>&1
    if errorlevel 1 (
        echo %RED%‚ùå Erreur lors de l'extraction !%RESET%
        call :log "ERREUR: Extraction ZIP √©chou√©e"
        exit /b 1
    )
    
    echo %GREEN%   ‚úÖ Fichiers extraits avec succ√®s%RESET%
    exit /b 0

:download_pageforge
    call :log "T√©l√©chargement PageForge"
    echo %BLUE%   üì• T√©l√©chargement de PageForge...%RESET%
    
    :: URL de t√©l√©chargement (√† adapter selon vos besoins)
    set "download_url=https://github.com/pageforge/releases/latest/download/pageforge.zip"
    
    :: T√©l√©chargement avec PowerShell
    powershell -Command "Invoke-WebRequest -Uri '%download_url%' -OutFile 'pageforge.zip'" > nul 2>&1
    if errorlevel 1 (
        echo %RED%‚ùå √âchec du t√©l√©chargement !%RESET%
        echo    Veuillez t√©l√©charger manuellement PageForge
        call :log "ERREUR: T√©l√©chargement √©chou√©"
        exit /b 1
    )
    
    echo %GREEN%   ‚úÖ T√©l√©chargement termin√©%RESET%
    call :extract_zip "pageforge.zip"
    exit /b 0

:install_dependencies
    call :log "Installation des d√©pendances NPM"
    
    cd "%INSTALL_DIR%"
    
    :: V√©rification du package.json
    if not exist "package.json" (
        echo %RED%‚ùå Fichier package.json non trouv√© !%RESET%
        call :log "ERREUR: package.json manquant"
        exit /b 1
    )
    
    echo %BLUE%   üì¶ Installation des d√©pendances...%RESET%
    echo    (Cela peut prendre quelques minutes)
    
    npm install --silent > "%LOG_FILE%" 2>&1
    if errorlevel 1 (
        echo %RED%‚ùå Erreur lors de l'installation NPM !%RESET%
        echo    Consultez les logs : %LOG_FILE%
        call :log "ERREUR: Installation NPM √©chou√©e"
        exit /b 1
    )
    
    echo %GREEN%   ‚úÖ D√©pendances install√©es avec succ√®s%RESET%
    call :log "D√©pendances NPM install√©es"
    exit /b 0

:configure_environment
    call :log "Configuration de l'environnement"
    
    cd "%INSTALL_DIR%"
    
    :: Copier le fichier .env.example vers .env
    if exist ".env.example" (
        copy ".env.example" ".env" > nul
        echo %GREEN%   ‚úÖ Fichier .env cr√©√© depuis .env.example%RESET%
    ) else (
        :: Cr√©er un .env basique
        echo # PageForge - Configuration Locale > .env
        echo NODE_ENV=development >> .env
        echo PORT=5000 >> .env
        echo DATABASE_URL=postgresql://localhost:5432/pageforge >> .env
        echo %GREEN%   ‚úÖ Fichier .env cr√©√© avec configuration par d√©faut%RESET%
    )
    
    :: Information sur la base de donn√©es
    echo.
    echo %YELLOW%üìã Configuration Base de Donn√©es :%RESET%
    echo    Par d√©faut : PostgreSQL local (postgresql://localhost:5432/pageforge)
    echo    Pour modifier : √âditez le fichier %INSTALL_DIR%\.env
    echo.
    
    call :log "Environnement configur√©"
    exit /b 0

:finalize_installation
    call :log "Finalisation de l'installation"
    
    cd "%INSTALL_DIR%"
    
    :: Test de l'installation
    echo %BLUE%   üß™ Test de l'installation...%RESET%
    npm run check > nul 2>&1
    if errorlevel 1 (
        echo %YELLOW%‚ö†Ô∏è  Avertissement : Tests √©chou√©s (non bloquant)%RESET%
        call :log "Avertissement: Tests √©chou√©s"
    ) else (
        echo %GREEN%   ‚úÖ Tests r√©ussis%RESET%
        call :log "Tests r√©ussis"
    )
    
    :: Cr√©er des raccourcis utiles
    echo @echo off > start-pageforge.bat
    echo cd "%INSTALL_DIR%" >> start-pageforge.bat
    echo npm run dev >> start-pageforge.bat
    
    echo @echo off > build-pageforge.bat
    echo cd "%INSTALL_DIR%" >> build-pageforge.bat
    echo npm run build >> build-pageforge.bat
    
    echo %GREEN%   ‚úÖ Raccourcis cr√©√©s%RESET%
    
    :: Cr√©er un dossier docs avec informations
    mkdir docs 2>nul
    echo # PageForge - Installation Locale Windows > docs\README.md
    echo. >> docs\README.md
    echo Installation termin√©e le %DATE% √† %TIME% >> docs\README.md
    echo Dossier d'installation : %INSTALL_DIR% >> docs\README.md
    echo. >> docs\README.md
    echo ## Commandes utiles : >> docs\README.md
    echo - D√©marrer : npm run dev >> docs\README.md
    echo - Build : npm run build >> docs\README.md
    echo - Tests : npm run check >> docs\README.md
    
    call :log "Installation finalis√©e"
    exit /b 0

:log
    echo %DATE% %TIME% - %~1 >> "%LOG_FILE%"
    exit /b 0

:error
    echo.
    echo %RED%‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó%RESET%
    echo %RED%‚ïë                     ‚ùå ERREUR D'INSTALLATION                  ‚ïë%RESET%
    echo %RED%‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù%RESET%
    echo.
    echo %RED%L'installation a √©chou√©.%RESET%
    echo %YELLOW%Consultez les logs pour plus de d√©tails : %LOG_FILE%%RESET%
    echo.
    call :log "Installation √©chou√©e"
    pause
    exit /b 1