#!/bin/bash

# PageForge - Installation Linux/macOS
# Installation automatique et interactive
# Version 1.0.0

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
RESET='\033[0m'

# Configuration
INSTALL_DIR="./pageforge"
NODE_MIN_VERSION=18
REQUIRED_SPACE_MB=500
LOG_FILE="/tmp/pageforge-install.log"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Fonctions utilitaires
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

print_header() {
    clear
    echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${RESET}"
    echo -e "${BLUE}‚ïë                    üöÄ PAGEFORGE INSTALLER                    ‚ïë${RESET}"
    echo -e "${BLUE}‚ïë                 Installation Automatique Linux              ‚ïë${RESET}"
    echo -e "${BLUE}‚ïë                        Version 1.0.0                        ‚ïë${RESET}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${RESET}"
    echo
}

print_step() {
    echo -e "${BLUE}[$1/7]${RESET} $2"
}

print_success() {
    echo -e "${GREEN}   ‚úÖ $1${RESET}"
}

print_error() {
    echo -e "${RED}   ‚ùå $1${RESET}"
}

print_warning() {
    echo -e "${YELLOW}   ‚ö†Ô∏è  $1${RESET}"
}

print_info() {
    echo -e "${CYAN}   ‚ÑπÔ∏è  $1${RESET}"
}

# D√©tection de l'OS
detect_os() {
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        OS="linux"
        DISTRO=$(lsb_release -si 2>/dev/null || echo "Unknown")
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        OS="macos"
        DISTRO="macOS"
    else
        OS="unknown"
        DISTRO="Unknown"
    fi
    
    log "OS d√©tect√©: $OS ($DISTRO)"
}

# V√©rification des pr√©requis syst√®me
check_prerequisites() {
    log "D√©but v√©rification pr√©requis"
    print_step 1 "V√©rification des pr√©requis syst√®me..."
    
    # V√©rification de l'espace disque
    local available_space
    if [[ "$OS" == "macos" ]]; then
        available_space=$(df -m . | awk 'NR==2 {print $4}')
    else
        available_space=$(df -BM . | awk 'NR==2 {gsub(/M/, "", $4); print $4}')
    fi
    
    if [[ $available_space -lt $REQUIRED_SPACE_MB ]]; then
        print_error "Espace disque insuffisant !"
        echo "   Requis : ${REQUIRED_SPACE_MB} MB"
        echo "   Disponible : ${available_space} MB"
        log "ERREUR: Espace disque insuffisant"
        return 1
    fi
    
    print_success "Espace disque suffisant (${available_space} MB disponibles)"
    
    # V√©rification des permissions
    if [[ ! -w "." ]]; then
        print_error "Permissions d'√©criture insuffisantes !"
        log "ERREUR: Permissions insuffisantes"
        return 1
    fi
    
    print_success "Permissions suffisantes"
    
    # V√©rification des commandes essentielles
    local missing_commands=()
    
    for cmd in curl wget unzip; do
        if ! command -v "$cmd" &> /dev/null; then
            missing_commands+=("$cmd")
        fi
    done
    
    if [[ ${#missing_commands[@]} -gt 0 ]]; then
        print_warning "Commandes manquantes : ${missing_commands[*]}"
        echo -e "${YELLOW}   Installation automatique des d√©pendances...${RESET}"
        
        if ! install_system_dependencies; then
            print_error "Impossible d'installer les d√©pendances syst√®me !"
            return 1
        fi
    fi
    
    print_success "Outils syst√®me disponibles"
    log "Pr√©requis valid√©s"
    return 0
}

# Installation des d√©pendances syst√®me
install_system_dependencies() {
    log "Installation d√©pendances syst√®me"
    
    case "$DISTRO" in
        "Ubuntu"|"Debian")
            sudo apt-get update -qq
            sudo apt-get install -y curl wget unzip build-essential
            ;;
        "CentOS"|"RedHat"|"Fedora")
            if command -v dnf &> /dev/null; then
                sudo dnf install -y curl wget unzip gcc gcc-c++ make
            else
                sudo yum install -y curl wget unzip gcc gcc-c++ make
            fi
            ;;
        "macOS")
            # V√©rifier si Homebrew est install√©
            if ! command -v brew &> /dev/null; then
                print_info "Installation de Homebrew..."
                /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            fi
            brew install curl wget
            ;;
        *)
            print_warning "Distribution non reconnue, installation manuelle requise"
            return 1
            ;;
    esac
    
    return 0
}

# V√©rification de Node.js
check_nodejs() {
    log "V√©rification Node.js"
    print_step 2 "V√©rification de Node.js..."
    
    # V√©rifier si Node.js est install√©
    if ! command -v node &> /dev/null; then
        print_error "Node.js n'est pas install√© !"
        echo
        echo -e "${YELLOW}üì• Installation de Node.js requise :${RESET}"
        
        read -p "   Voulez-vous installer Node.js automatiquement ? (O/n): " install_node
        if [[ $install_node =~ ^[Oo]$ ]] || [[ -z $install_node ]]; then
            if ! install_nodejs; then
                return 1
            fi
        else
            echo "   1. Installez Node.js depuis : https://nodejs.org"
            echo "   2. Ou utilisez un gestionnaire de paquets :"
            echo "      - Ubuntu/Debian: sudo apt install nodejs npm"
            echo "      - CentOS/RHEL: sudo yum install nodejs npm"
            echo "      - macOS: brew install node"
            echo "   3. Red√©marrez ce script apr√®s installation"
            log "ERREUR: Node.js non install√©"
            return 1
        fi
    fi
    
    # V√©rifier la version
    local node_version
    node_version=$(node --version | sed 's/v//')
    local node_major
    node_major=$(echo "$node_version" | cut -d. -f1)
    
    if [[ $node_major -lt $NODE_MIN_VERSION ]]; then
        print_error "Version Node.js insuffisante !"
        echo "   Version install√©e : $node_version"
        echo "   Version requise : $NODE_MIN_VERSION+"
        log "ERREUR: Version Node.js insuffisante"
        return 1
    fi
    
    print_success "Node.js version $node_version d√©tect√©"
    
    # V√©rifier NPM
    if ! command -v npm &> /dev/null; then
        print_error "NPM non disponible !"
        log "ERREUR: NPM non disponible"
        return 1
    fi
    
    local npm_version
    npm_version=$(npm --version)
    print_success "NPM version $npm_version disponible"
    
    log "Node.js et NPM valid√©s"
    return 0
}

# Installation automatique de Node.js
install_nodejs() {
    log "Installation automatique Node.js"
    print_info "Installation de Node.js..."
    
    case "$DISTRO" in
        "Ubuntu"|"Debian")
            # Utiliser le d√©p√¥t NodeSource
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
            ;;
        "CentOS"|"RedHat"|"Fedora")
            # Utiliser le d√©p√¥t NodeSource
            curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
            sudo yum install -y nodejs
            ;;
        "macOS")
            if command -v brew &> /dev/null; then
                brew install node
            else
                print_error "Homebrew requis pour l'installation automatique sur macOS"
                return 1
            fi
            ;;
        *)
            # Installation via gestionnaire de version Node
            print_info "Installation via Node Version Manager (nvm)..."
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install 18
            nvm use 18
            ;;
    esac
    
    # V√©rifier l'installation
    if command -v node &> /dev/null; then
        print_success "Node.js install√© avec succ√®s"
        return 0
    else
        print_error "√âchec de l'installation de Node.js"
        return 1
    fi
}

# Pr√©paration du dossier d'installation
prepare_directory() {
    log "Pr√©paration dossier d'installation"
    print_step 3 "Pr√©paration du dossier d'installation..."
    
    # Cr√©er le dossier d'installation
    if [[ -d "$INSTALL_DIR" ]]; then
        print_warning "Le dossier $INSTALL_DIR existe d√©j√†"
        read -p "   Voulez-vous le remplacer ? (O/n): " overwrite
        if [[ $overwrite =~ ^[Oo]$ ]] || [[ -z $overwrite ]]; then
            print_info "Suppression du dossier existant..."
            rm -rf "$INSTALL_DIR"
            log "Dossier existant supprim√©"
        else
            print_error "Installation annul√©e par l'utilisateur"
            log "Installation annul√©e"
            return 1
        fi
    fi
    
    mkdir -p "$INSTALL_DIR"
    if [[ ! -d "$INSTALL_DIR" ]]; then
        print_error "Impossible de cr√©er le dossier d'installation !"
        log "ERREUR: Cr√©ation dossier impossible"
        return 1
    fi
    
    print_success "Dossier d'installation cr√©√©"
    log "Dossier d'installation pr√©par√©"
    return 0
}

# Installation des fichiers
install_files() {
    log "Installation des fichiers"
    print_step 4 "Installation des fichiers PageForge..."
    
    # Recherche du fichier ZIP
    local zip_files=(pageforge-*.zip pageforge.zip build.zip)
    local zip_found=""
    
    for pattern in "${zip_files[@]}"; do
        for file in $pattern; do
            if [[ -f "$file" ]]; then
                zip_found="$file"
                break 2
            fi
        done
    done
    
    if [[ -z "$zip_found" ]]; then
        print_warning "Aucun fichier ZIP PageForge trouv√©"
        echo
        echo -e "${BLUE}üì¶ Options d'installation :${RESET}"
        echo "   1. Placez le fichier pageforge.zip dans ce dossier"
        echo "   2. Ou t√©l√©chargement automatique (si disponible)"
        echo
        
        read -p "T√©l√©charger automatiquement ? (O/n): " download_option
        if [[ $download_option =~ ^[Oo]$ ]] || [[ -z $download_option ]]; then
            if ! download_pageforge; then
                return 1
            fi
        else
            print_error "Fichier PageForge requis !"
            log "ERREUR: Fichier ZIP non trouv√©"
            return 1
        fi
    else
        print_success "Fichier trouv√© : $zip_found"
        if ! extract_zip "$zip_found"; then
            return 1
        fi
    fi
    
    log "Fichiers install√©s"
    return 0
}

# Extraction du fichier ZIP
extract_zip() {
    local zip_file="$1"
    log "Extraction du fichier ZIP : $zip_file"
    
    if ! unzip -q "$zip_file" -d "$INSTALL_DIR"; then
        print_error "Erreur lors de l'extraction !"
        log "ERREUR: Extraction ZIP √©chou√©e"
        return 1
    fi
    
    print_success "Fichiers extraits avec succ√®s"
    return 0
}

# T√©l√©chargement de PageForge
download_pageforge() {
    log "T√©l√©chargement PageForge"
    print_info "T√©l√©chargement de PageForge..."
    
    # URL de t√©l√©chargement (√† adapter selon vos besoins)
    local download_url="https://github.com/pageforge/releases/latest/download/pageforge.zip"
    
    if command -v curl &> /dev/null; then
        curl -L "$download_url" -o "pageforge.zip"
    elif command -v wget &> /dev/null; then
        wget "$download_url" -O "pageforge.zip"
    else
        print_error "Impossible de t√©l√©charger (curl ou wget requis) !"
        log "ERREUR: Pas d'outil de t√©l√©chargement"
        return 1
    fi
    
    if [[ ! -f "pageforge.zip" ]]; then
        print_error "√âchec du t√©l√©chargement !"
        echo "   Veuillez t√©l√©charger manuellement PageForge"
        log "ERREUR: T√©l√©chargement √©chou√©"
        return 1
    fi
    
    print_success "T√©l√©chargement termin√©"
    extract_zip "pageforge.zip"
    return $?
}

# Installation des d√©pendances NPM
install_dependencies() {
    log "Installation d√©pendances NPM"
    print_step 5 "Installation des d√©pendances NPM..."
    
    cd "$INSTALL_DIR" || return 1
    
    # V√©rification du package.json
    if [[ ! -f "package.json" ]]; then
        print_error "Fichier package.json non trouv√© !"
        log "ERREUR: package.json manquant"
        return 1
    fi
    
    print_info "Installation des d√©pendances..."
    echo "   (Cela peut prendre quelques minutes)"
    
    if ! npm install --silent >> "$LOG_FILE" 2>&1; then
        print_error "Erreur lors de l'installation NPM !"
        echo "   Consultez les logs : $LOG_FILE"
        log "ERREUR: Installation NPM √©chou√©e"
        return 1
    fi
    
    print_success "D√©pendances install√©es avec succ√®s"
    log "D√©pendances NPM install√©es"
    cd - > /dev/null
    return 0
}

# Configuration de l'environnement
configure_environment() {
    log "Configuration de l'environnement"
    print_step 6 "Configuration de l'environnement..."
    
    cd "$INSTALL_DIR" || return 1
    
    # Copier le fichier .env.example vers .env
    if [[ -f ".env.example" ]]; then
        cp ".env.example" ".env"
        print_success "Fichier .env cr√©√© depuis .env.example"
    else
        # Cr√©er un .env basique
        cat > .env << EOF
# PageForge - Configuration Locale
NODE_ENV=development
PORT=5000
DATABASE_URL=postgresql://localhost:5432/pageforge
EOF
        print_success "Fichier .env cr√©√© avec configuration par d√©faut"
    fi
    
    # Information sur la base de donn√©es
    echo
    echo -e "${YELLOW}üìã Configuration Base de Donn√©es :${RESET}"
    echo "   Par d√©faut : PostgreSQL local (postgresql://localhost:5432/pageforge)"
    echo "   Pour modifier : √âditez le fichier $INSTALL_DIR/.env"
    echo
    
    log "Environnement configur√©"
    cd - > /dev/null
    return 0
}

# Finalisation de l'installation
finalize_installation() {
    log "Finalisation de l'installation"
    print_step 7 "Tests et finalisation..."
    
    cd "$INSTALL_DIR" || return 1
    
    # Test de l'installation
    print_info "Test de l'installation..."
    if npm run check >> "$LOG_FILE" 2>&1; then
        print_success "Tests r√©ussis"
        log "Tests r√©ussis"
    else
        print_warning "Avertissement : Tests √©chou√©s (non bloquant)"
        log "Avertissement: Tests √©chou√©s"
    fi
    
    # Cr√©er des scripts utiles
    cat > start-pageforge.sh << 'EOF'
#!/bin/bash
cd "$(dirname "$0")"
npm run dev
EOF
    chmod +x start-pageforge.sh
    
    cat > build-pageforge.sh << 'EOF'
#!/bin/bash
cd "$(dirname "$0")"
npm run build
EOF
    chmod +x build-pageforge.sh
    
    print_success "Scripts utiles cr√©√©s"
    
    # Cr√©er documentation
    mkdir -p docs
    cat > docs/README.md << EOF
# PageForge - Installation Locale Linux/macOS

Installation termin√©e le $(date)
Dossier d'installation : $INSTALL_DIR

## Commandes utiles :
- D√©marrer : ./start-pageforge.sh ou npm run dev
- Build : ./build-pageforge.sh ou npm run build  
- Tests : npm run check

## URLs :
- Application : http://localhost:5000
- Documentation : docs/

## Configuration :
- Fichier d'environnement : .env
- Configuration base de donn√©es : DATABASE_URL dans .env
EOF
    
    print_success "Documentation cr√©√©e"
    log "Installation finalis√©e"
    cd - > /dev/null
    return 0
}

# Fonction principale
main() {
    # Initialisation
    echo "=== PageForge Installation Linux/macOS ===" > "$LOG_FILE"
    echo "D√©but d'installation : $(date)" >> "$LOG_FILE"
    
    detect_os
    print_header
    
    echo -e "${YELLOW}[INFO]${RESET} D√©marrage de l'installation PageForge..."
    echo -e "${YELLOW}[INFO]${RESET} Dossier d'installation : $INSTALL_DIR"
    echo -e "${YELLOW}[INFO]${RESET} Syst√®me d√©tect√© : $OS ($DISTRO)"
    echo
    
    # Ex√©cution des √©tapes
    if ! check_prerequisites; then
        exit 1
    fi
    
    if ! check_nodejs; then
        exit 1
    fi
    
    if ! prepare_directory; then
        exit 1
    fi
    
    if ! install_files; then
        exit 1
    fi
    
    if ! install_dependencies; then
        exit 1
    fi
    
    if ! configure_environment; then
        exit 1
    fi
    
    if ! finalize_installation; then
        exit 1
    fi
    
    # Succ√®s
    echo
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${RESET}"
    echo -e "${GREEN}‚ïë                  ‚úÖ INSTALLATION R√âUSSIE !                   ‚ïë${RESET}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${RESET}"
    echo
    echo -e "${GREEN}üéâ PageForge a √©t√© install√© avec succ√®s !${RESET}"
    echo
    echo -e "${YELLOW}üìÅ Dossier d'installation :${RESET} $INSTALL_DIR"
    echo -e "${YELLOW}üåê URL d'acc√®s :${RESET} http://localhost:5000"
    echo
    echo -e "${BLUE}üöÄ Pour d√©marrer PageForge :${RESET}"
    echo "   cd \"$INSTALL_DIR\""
    echo "   npm run dev"
    echo "   # ou"
    echo "   ./start-pageforge.sh"
    echo
    echo -e "${YELLOW}üìñ Documentation compl√®te disponible dans :${RESET} $INSTALL_DIR/docs/"
    echo
    
    # Proposition de d√©marrage automatique
    read -p "Voulez-vous d√©marrer PageForge maintenant ? (O/n): " start_now
    if [[ $start_now =~ ^[Oo]$ ]] || [[ -z $start_now ]]; then
        echo -e "${BLUE}[INFO]${RESET} D√©marrage de PageForge..."
        cd "$INSTALL_DIR"
        echo -e "${GREEN}‚úÖ PageForge d√©marr√© !${RESET} Ouvrez http://localhost:5000 dans votre navigateur"
        npm run dev
    fi
    
    log "Installation termin√©e avec succ√®s"
}

# Gestion des erreurs
trap 'echo -e "\n${RED}‚ùå Installation interrompue !${RESET}"; log "Installation interrompue"; exit 1' INT TERM

# Lancement du script
main "$@"